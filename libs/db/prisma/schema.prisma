generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id            String         @id @default(cuid())
    email         String         @unique
    passwordHash  String
    portfolios    Portfolio[]
    refreshTokens RefreshToken[]

    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt
}

model RefreshToken {
    id        String   @id @default(cuid())
    userId    String
    tokenHash String
    expiresAt DateTime
    createdAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, tokenHash])
    @@index([userId])
    @@index([expiresAt])
}

model Portfolio {
    id           String   @id @default(cuid())
    userId       String
    name         String
    baseCurrency String   @default("USD")
    createdAt    DateTime @default(now())

    user         User          @relation(fields: [userId], references: [id])
    transactions Transaction[]
}

model Asset {
    id        String   @id @default(cuid())
    symbol    String   @unique
    name      String
    type      String
    createdAt DateTime @default(now())

    transactions   Transaction[]
    priceSnapshots PriceSnapshot[]
}

model Transaction {
    id          String   @id @default(cuid())
    portfolioId String
    assetId     String
    type        String
    quantity    Decimal  @db.Decimal(36, 18)
    price       Decimal? @db.Decimal(36, 18)
    fee         Decimal? @db.Decimal(36, 18)
    feeCurrency String?  @default("USD")
    at          DateTime
    exchange    String?
    note        String?
    createdAt   DateTime @default(now())

    portfolio Portfolio @relation(fields: [portfolioId], references: [id])
    asset     Asset     @relation(fields: [assetId], references: [id])

    @@index([portfolioId, at])
}

model PriceSnapshot {
    id        String   @id @default(cuid())
    assetId   String
    currency  String   @default("USD")
    price     Decimal  @db.Decimal(36, 18)
    source    String
    at        DateTime
    createdAt DateTime @default(now())

    asset Asset @relation(fields: [assetId], references: [id])

    @@index([assetId, currency, at(sort: Desc)])
}
